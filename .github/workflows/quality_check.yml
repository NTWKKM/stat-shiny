name: Quality Assurance

on:
  push:
    branches:
      - main
      - develop
      - fix
      - patch
  pull_request:
    branches:
      - main
      - develop

jobs:
  # ==========================================
  # Unit Tests (Matrix: 3.11 - 3.14)
  # ==========================================
  unit-tests:
    name: Unit Tests (Py ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false # ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏û‡∏±‡∏á ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏¢‡∏±‡∏á‡∏£‡∏±‡∏ô‡∏ï‡πà‡∏≠
      matrix:
        python-version: ["3.11", "3.12", "3.13", "3.14-dev"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"
          allow-prereleases: true # ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ 3.14-dev

      - name: Install Dependencies
        # 3.14 ‡∏≠‡∏≤‡∏à‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ wheel ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö numpy/pandas -> ‡πÉ‡∏´‡πâ continue-on-error ‡∏ñ‡πâ‡∏≤ install ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô
        continue-on-error: ${{ contains(matrix.python-version, '3.14') }}
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest

      - name: Run Unit Tests
        # ‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ 3.14 ‡∏û‡∏±‡∏á‡πÑ‡∏î‡πâ (Experimental) ‡πÅ‡∏ï‡πà‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ô
        continue-on-error: ${{ contains(matrix.python-version, '3.14') }}
        run: |
          pytest tests/unit/ -v --tb=short
          pytest tests/test_plotly_html_rendering.py -v --tb=short

  # ==========================================
  # E2E Tests (Stick to stable 3.12 to save resources)
  # ==========================================
  e2e-tests:
    name: E2E Tests (Py 3.12)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-playwright

      - name: Install Playwright Browsers
        run: |
          playwright install chromium
          playwright install-deps chromium

      - name: Run E2E Tests
        run: |
          pytest tests/e2e/ -v --tb=short -m e2e
        env:
          PYTHONUNBUFFERED: "1"
        timeout-minutes: 10

      - name: Upload Playwright Report (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

  # ==========================================
  # Integration Tests (Matrix: 3.11 - 3.14)
  # ==========================================
  integration-tests:
    name: Integration Tests (Py ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11", "3.12", "3.13", "3.14-dev"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"
          allow-prereleases: true

      - name: Install Dependencies
        continue-on-error: ${{ contains(matrix.python-version, '3.14') }}
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest

      - name: Run Integration Tests
        continue-on-error: ${{ contains(matrix.python-version, '3.14') }}
        run: |
          pytest tests/integration/ -v --tb=short

  # ==========================================
  # Code Quality Checks (Stable 3.12)
  # ==========================================
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8 pylint black isort

      - name: Check imports with isort
        run: isort --check-only . --skip venv
        continue-on-error: true

      - name: Check formatting with black
        run: black --check . --exclude venv
        continue-on-error: true

      - name: Lint with flake8
        run: flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        continue-on-error: true

  # ==========================================
  # Test Summary
  # ==========================================
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    # ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å Job (‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á Matrix ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î) ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô
    needs: [unit-tests, e2e-tests, integration-tests, code-quality]
    if: always()

    steps:
      - name: Check test results
        run: |
          echo "==========================================="
          echo "üìä Test Summary"
          echo "==========================================="
          echo "‚úÖ Unit Tests:        ${{ needs.unit-tests.result }}"
          echo "‚úÖ E2E Tests:         ${{ needs.e2e-tests.result }}"
          echo "‚úÖ Integration Tests: ${{ needs.integration-tests.result }}"
          echo "‚úÖ Code Quality:      ${{ needs.code-quality.result }}"
          echo "==========================================="

          # Fail ‡∏ñ‡πâ‡∏≤ Unit/E2E/Integration (‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å) ‡∏û‡∏±‡∏á
          # ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: matrix ‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á continue-on-error=true (‡πÄ‡∏ä‡πà‡∏ô 3.14) ‡∏à‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ success ‡πÅ‡∏°‡πâ‡∏û‡∏±‡∏á
          # ‡∏î‡∏±‡∏á‡∏ô‡∏±‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏à‡∏∞ fail ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ñ‡πâ‡∏≤ 3.11-3.13 ‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤
          if [ "${{ needs.unit-tests.result }}" = "failure" ] || \
             [ "${{ needs.e2e-tests.result }}" = "failure" ] || \
             [ "${{ needs.integration-tests.result }}" = "failure" ]; then
            echo "‚ùå CRITICAL: One or more test suites failed."
            exit 1
          elif [ "${{ needs.code-quality.result }}" = "failure" ]; then
            echo "‚ö†Ô∏è WARNING: Code quality checks failed, but tests passed."
            exit 0
          else
            echo "‚úÖ All checks passed successfully!"
          fi
