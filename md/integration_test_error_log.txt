Run pytest tests/integration/ -v --tb=short

======================================================================
ðŸ“Š Starting Test Session
======================================================================
============================= test session starts ==============================
platform linux -- Python 3.12.12, pytest-9.0.2, pluggy-1.6.0 -- /opt/hostedtoolcache/Python/3.12.12/x64/bin/python
cachedir: .pytest_cache
rootdir: /home/runner/work/stat-shiny/stat-shiny
configfile: pytest.ini
plugins: shiny-1.5.1, base-url-2.1.0, playwright-0.7.2, asyncio-1.3.0, anyio-4.12.1
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 67 items

tests/integration/test_advanced_features.py::TestAdvancedFeatures::test_negative_binomial_flow PASSED [  1%]
tests/integration/test_advanced_features.py::TestAdvancedFeatures::test_causal_pipeline_psm_ipw FAILED [  2%]
tests/integration/test_advanced_features.py::TestAdvancedFeatures::test_mediation_analysis_flow PASSED [  4%]
tests/integration/test_advanced_features.py::TestAdvancedFeatures::test_stratified_analysis_flow PASSED [  5%]
tests/integration/test_corr_cleaning.py::TestCorrPipeline::test_calculate_correlation_pipeline FAILED [  7%]
tests/integration/test_corr_cleaning.py::TestCorrPipeline::test_compute_correlation_matrix_pipeline PASSED [  8%]
tests/integration/test_corr_pipeline.py::TestCorrelationPipeline::test_pearson_correlation_flow PASSED [ 10%]
tests/integration/test_corr_pipeline.py::TestCorrelationPipeline::test_spearman_correlation_flow PASSED [ 11%]
tests/integration/test_corr_pipeline.py::TestCorrelationPipeline::test_missing_values_handling PASSED [ 13%]
tests/integration/test_corr_pipeline.py::TestCorrelationPipeline::test_invalid_columns PASSED [ 14%]
tests/integration/test_corr_pipeline.py::TestCorrelationPipeline::test_insufficient_columns PASSED [ 16%]
tests/integration/test_data_cleaning_pipeline.py::TestDataPipeline::test_html_report_generation PASSED [ 17%]
tests/integration/test_data_cleaning_pipeline.py::TestDataPipeline::test_logic_integration PASSED [ 19%]
tests/integration/test_data_cleaning_pipeline.py::TestDataPipeline::test_prepare_data_custom_codes PASSED [ 20%]
tests/integration/test_data_cleaning_pipeline.py::TestDataPipeline::test_prepare_data_simple PASSED [ 22%]
tests/integration/test_diag_cleaning.py::test_chi2_pipeline_integration PASSED [ 23%]
tests/integration/test_diag_cleaning.py::test_roc_pipeline_integration PASSED [ 25%]
tests/integration/test_diag_cleaning.py::test_descriptive_pipeline_integration PASSED [ 26%]
tests/integration/test_diag_pipeline.py::TestDiagnosticPipeline::test_chi_square_flow PASSED [ 28%]
tests/integration/test_diag_pipeline.py::TestDiagnosticPipeline::test_roc_analysis_flow PASSED [ 29%]
tests/integration/test_diag_pipeline.py::TestDiagnosticPipeline::test_agreement_flow PASSED [ 31%]
tests/integration/test_diag_pipeline.py::TestDiagnosticPipeline::test_icc_flow PASSED [ 32%]
tests/integration/test_forest_plot_lib.py::TestForestPlotLib::test_basic_forest_plot PASSED [ 34%]
tests/integration/test_forest_plot_lib.py::TestForestPlotLib::test_forest_plot_customization PASSED [ 35%]
tests/integration/test_forest_plot_lib.py::TestForestPlotLib::test_plot_with_missing_interaction PASSED [ 37%]
tests/integration/test_forest_plot_lib.py::TestForestPlotLib::test_empty_dataframe PASSED [ 38%]
tests/integration/test_interaction_pipeline.py::TestInteractionPipeline::test_create_interaction_terms PASSED [ 40%]
tests/integration/test_interaction_pipeline.py::TestInteractionPipeline::test_interaction_pipeline_integration PASSED [ 41%]
tests/integration/test_logic_pipeline.py::TestLogicPipeline::test_complete_logic_flow PASSED [ 43%]
tests/integration/test_logic_pipeline.py::TestLogicPipeline::test_logic_to_forest_plot_integration PASSED [ 44%]
tests/integration/test_logic_pipeline.py::TestLogicPipeline::test_data_flow_with_numeric_cleaning PASSED [ 46%]
tests/integration/test_logic_pipeline.py::TestLogicPipeline::test_pipeline_with_multiple_covariates PASSED [ 47%]
tests/integration/test_logic_pipeline.py::TestLogicPipeline::test_pipeline_robustness_with_subset PASSED [ 49%]
tests/integration/test_logic_pipeline.py::TestLogicPipeline::test_outcome_variable_consistency PASSED [ 50%]
tests/integration/test_logic_pipeline.py::TestLogicPipeline::test_pipeline_with_missing_values PASSED [ 52%]
tests/integration/test_logic_pipeline.py::TestLogicPipeline::test_pipeline_with_constant_outcome PASSED [ 53%]
tests/integration/test_poisson_cleaning.py::test_poisson_pipeline_integration PASSED [ 55%]
tests/integration/test_poisson_cleaning.py::test_poisson_pipeline_all_missing PASSED [ 56%]
tests/integration/test_poisson_pipeline.py::TestPoissonPipeline::test_poisson_regression_flow PASSED [ 58%]
tests/integration/test_poisson_pipeline.py::TestPoissonPipeline::test_negative_binomial_flow PASSED [ 59%]
tests/integration/test_psm_pipeline.py::TestPSMPipeline::test_psm_full_flow FAILED [ 61%]
tests/integration/test_psm_pipeline.py::TestPSMPipeline::test_love_plot_generation PASSED [ 62%]
tests/integration/test_psm_pipeline.py::TestPSMPipeline::test_psm_no_matches PASSED [ 64%]
tests/integration/test_robustness_check.py::TestStatisticalModulesRobustness::test_advanced_stats_robustness FAILED [ 65%]
tests/integration/test_robustness_check.py::TestStatisticalModulesRobustness::test_correlation_robustness FAILED [ 67%]
tests/integration/test_robustness_check.py::TestStatisticalModulesRobustness::test_diag_test_robustness PASSED [ 68%]
tests/integration/test_robustness_check.py::TestStatisticalModulesRobustness::test_forest_plot_robustness FAILED [ 70%]
tests/integration/test_robustness_check.py::TestStatisticalModulesRobustness::test_interaction_lib_robustness PASSED [ 71%]
tests/integration/test_robustness_check.py::TestStatisticalModulesRobustness::test_linear_robustness PASSED [ 73%]
tests/integration/test_robustness_check.py::TestStatisticalModulesRobustness::test_logistic_robustness FAILED [ 74%]
tests/integration/test_robustness_check.py::TestStatisticalModulesRobustness::test_psm_lib_robustness FAILED [ 76%]
tests/integration/test_robustness_check.py::TestStatisticalModulesRobustness::test_sample_size_robustness PASSED [ 77%]
tests/integration/test_robustness_check.py::TestStatisticalModulesRobustness::test_subgroup_robustness FAILED [ 79%]
tests/integration/test_robustness_check.py::TestStatisticalModulesRobustness::test_tvc_robustness PASSED [ 80%]
tests/integration/test_subgroup_pipeline.py::TestSubgroupAnalysisPipeline::test_subgroup_analysis_logit_flow PASSED [ 82%]
tests/integration/test_subgroup_pipeline.py::TestSubgroupAnalysisPipeline::test_subgroup_forest_plot_generation PASSED [ 83%]
tests/integration/test_subgroup_pipeline.py::TestSubgroupAnalysisPipeline::test_invalid_inputs PASSED [ 85%]
tests/integration/test_survival_cleaning.py::TestSurvivalPipeline::test_fit_cox_ph_pipeline PASSED [ 86%]
tests/integration/test_survival_cleaning.py::TestSurvivalPipeline::test_fit_km_logrank_pipeline PASSED [ 88%]
tests/integration/test_survival_cleaning.py::TestSurvivalPipeline::test_fit_nelson_aalen_pipeline PASSED [ 89%]
tests/integration/test_survival_pipeline.py::TestSurvivalPipeline::test_full_survival_analysis_flow PASSED [ 91%]
tests/integration/test_survival_pipeline.py::TestSurvivalPipeline::test_cox_to_forest_plot_integration PASSED [ 92%]
tests/integration/test_survival_pipeline.py::TestSurvivalPipeline::test_nelson_aalen_cumulative_hazard PASSED [ 94%]
tests/integration/test_table_one_pipeline.py::TestTableOnePipeline::test_full_table_generation_html PASSED [ 95%]
tests/integration/test_table_one_pipeline.py::TestTableOnePipeline::test_statistical_calculations PASSED [ 97%]
tests/integration/test_table_one_pipeline.py::TestTableOnePipeline::test_smd_calculation_flow PASSED [ 98%]
tests/integration/test_table_one_pipeline.py::TestTableOnePipeline::test_table_generation_no_group PASSED [100%]
======================================================================
âœ… Test Session Complete
======================================================================


=================================== FAILURES ===================================
______________ TestAdvancedFeatures.test_causal_pipeline_psm_ipw _______________
tests/integration/test_advanced_features.py:107: in test_causal_pipeline_psm_ipw
    assert "ATE" in ipw_res
E   assert 'ATE' in {'error': "'numpy.ndarray' object has no attribute 'iloc'"}
----------------------------- Captured stdout call -----------------------------
2026-01-22 09:02:50 - utils.psm_lib - ERROR - IPW calculation failed: 'numpy.ndarray' object has no attribute 'iloc'
------------------------------ Captured log call -------------------------------
ERROR    utils.psm_lib:logger.py:148 IPW calculation failed: 'numpy.ndarray' object has no attribute 'iloc'
_____________ TestCorrPipeline.test_calculate_correlation_pipeline _____________
tests/integration/test_corr_cleaning.py:48: in test_calculate_correlation_pipeline
    assert results is not None
E   assert None is not None
----------------------------- Captured stdout call -----------------------------
2026-01-22 09:02:50 - utils.data_cleaning - ERROR - Failed to prepare data for analysis
Traceback (most recent call last):
  File "/home/runner/work/stat-shiny/stat-shiny/utils/data_cleaning.py", line 989, in prepare_data_for_analysis
    raise DataValidationError(f"Missing required columns: {missing_cols}")
utils.data_cleaning.DataValidationError: Missing required columns: {'1', 'v', 'r', 'a'}
------------------------------ Captured log call -------------------------------
ERROR    utils.data_cleaning:logger.py:156 Failed to prepare data for analysis
Traceback (most recent call last):
  File "/home/runner/work/stat-shiny/stat-shiny/utils/data_cleaning.py", line 989, in prepare_data_for_analysis
    raise DataValidationError(f"Missing required columns: {missing_cols}")
utils.data_cleaning.DataValidationError: Missing required columns: {'1', 'v', 'r', 'a'}
______________________ TestPSMPipeline.test_psm_full_flow ______________________
tests/integration/test_psm_pipeline.py:66: in test_psm_full_flow
    ps_series, _ = calculate_propensity_score(df, "treatment", covariates)
    ^^^^^^^^^^^^
E   ValueError: too many values to unpack (expected 2)
_______ TestStatisticalModulesRobustness.test_advanced_stats_robustness ________
tests/integration/test_robustness_check.py:192: in test_advanced_stats_robustness
    vif, missing = advanced_stats_lib.calculate_vif(self.empty_df)
    ^^^^^^^^^^^^
E   ValueError: too many values to unpack (expected 2)
_________ TestStatisticalModulesRobustness.test_correlation_robustness _________
tests/integration/test_robustness_check.py:173: in test_correlation_robustness
    self.assertIsNotNone(err)
E   AssertionError: unexpectedly None
_________ TestStatisticalModulesRobustness.test_forest_plot_robustness _________
tests/integration/test_robustness_check.py:232: in test_forest_plot_robustness
    fp = forest_plot_lib.ForestPlot(self.empty_df, 'OR', 'Low', 'High', 'Label')
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
utils/forest_plot_lib.py:53: in __init__
    raise ValueError("DataFrame cannot be empty")
E   ValueError: DataFrame cannot be empty
__________ TestStatisticalModulesRobustness.test_logistic_robustness ___________
tests/integration/test_robustness_check.py:78: in test_logistic_robustness
    self.assertIn("not found", html)
E   AssertionError: 'not found' not found in "<div class='alert alert-danger'><b>Data Preparation Failed:</b> Data preparation failed: No valid data remaining after cleaning (all rows contained missing values)</div>"
----------------------------- Captured stdout call -----------------------------
2026-01-22 09:03:03 - utils.data_cleaning - ERROR - Failed to prepare data for analysis
Traceback (most recent call last):
  File "/home/runner/work/stat-shiny/stat-shiny/utils/data_cleaning.py", line 1027, in prepare_data_for_analysis
    raise DataValidationError("No valid data remaining after cleaning (all rows contained missing values)")
utils.data_cleaning.DataValidationError: No valid data remaining after cleaning (all rows contained missing values)
2026-01-22 09:03:03 - utils.logic - ERROR - Data preparation for logistic analysis failed: Data preparation failed: No valid data remaining after cleaning (all rows contained missing values)
------------------------------ Captured log call -------------------------------
ERROR    utils.data_cleaning:logger.py:156 Failed to prepare data for analysis
Traceback (most recent call last):
  File "/home/runner/work/stat-shiny/stat-shiny/utils/data_cleaning.py", line 1027, in prepare_data_for_analysis
    raise DataValidationError("No valid data remaining after cleaning (all rows contained missing values)")
utils.data_cleaning.DataValidationError: No valid data remaining after cleaning (all rows contained missing values)
ERROR    utils.logic:logger.py:148 Data preparation for logistic analysis failed: Data preparation failed: No valid data remaining after cleaning (all rows contained missing values)
___________ TestStatisticalModulesRobustness.test_psm_lib_robustness ___________
tests/integration/test_robustness_check.py:120: in test_psm_lib_robustness
    ps, info = psm_lib.calculate_propensity_score(self.empty_df, 'treat', ['cov'])
    ^^^^^^^^
E   ValueError: not enough values to unpack (expected 2, got 0)
----------------------------- Captured stdout call -----------------------------
2026-01-22 09:03:03 - utils.data_cleaning - ERROR - Failed to prepare data for analysis
Traceback (most recent call last):
  File "/home/runner/work/stat-shiny/stat-shiny/utils/data_cleaning.py", line 989, in prepare_data_for_analysis
    raise DataValidationError(f"Missing required columns: {missing_cols}")
utils.data_cleaning.DataValidationError: Missing required columns: {'cov', 'treat'}
2026-01-22 09:03:03 - utils.psm_lib - ERROR - Propensity score calculation failed: Data preparation failed: Missing required columns: {'cov', 'treat'}
------------------------------ Captured log call -------------------------------
ERROR    utils.data_cleaning:logger.py:156 Failed to prepare data for analysis
Traceback (most recent call last):
  File "/home/runner/work/stat-shiny/stat-shiny/utils/data_cleaning.py", line 989, in prepare_data_for_analysis
    raise DataValidationError(f"Missing required columns: {missing_cols}")
utils.data_cleaning.DataValidationError: Missing required columns: {'cov', 'treat'}
ERROR    utils.psm_lib:logger.py:148 Propensity score calculation failed: Data preparation failed: Missing required columns: {'cov', 'treat'}
__________ TestStatisticalModulesRobustness.test_subgroup_robustness ___________
tests/integration/test_robustness_check.py:153: in test_subgroup_robustness
    res = sa.analyze('outcome', 'treatment', 'subgroup')
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
utils/subgroup_analysis_module.py:112: in analyze
    self.validate_inputs(
utils/subgroup_analysis_module.py:84: in validate_inputs
    raise ValueError(f"Missing columns: {missing}")
E   ValueError: Missing columns: {'treatment', 'subgroup', 'outcome'}
----------------------------- Captured stdout call -----------------------------
2026-01-22 09:03:03 - utils.subgroup_analysis_module - ERROR - Analysis failed: Missing columns: {'treatment', 'subgroup', 'outcome'}
------------------------------ Captured log call -------------------------------
ERROR    utils.subgroup_analysis_module:logger.py:148 Analysis failed: Missing columns: {'treatment', 'subgroup', 'outcome'}
=============================== warnings summary ===============================
tests/integration/test_poisson_cleaning.py::test_poisson_pipeline_integration
  /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/statsmodels/regression/_tools.py:121: RuntimeWarning:
  
  divide by zero encountered in scalar divide

tests/integration/test_poisson_cleaning.py::test_poisson_pipeline_integration
  /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/statsmodels/genmod/generalized_linear_model.py:1342: PerfectSeparationWarning:
  
  Perfect separation or prediction detected, parameter may not be identified

tests/integration/test_survival_cleaning.py::TestSurvivalPipeline::test_fit_cox_ph_pipeline
  /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/lifelines/fitters/coxph_fitter.py:1589: ConvergenceWarning:
  
  The log-likelihood is getting suspiciously close to 0 and the delta is still large. There may be complete separation in the dataset. This may result in incorrect inference of coefficients. See https://stats.stackexchange.com/q/11109/11867 for more.

tests/integration/test_survival_cleaning.py::TestSurvivalPipeline::test_fit_cox_ph_pipeline
  /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/lifelines/utils/__init__.py:1163: ConvergenceWarning:
  
  Column age has high sample correlation with the duration column. This may harm convergence. This could be a form of 'complete separation'.     See https://stats.stackexchange.com/questions/11109/how-to-deal-with-perfect-separation-in-logistic-regression

tests/integration/test_survival_cleaning.py::TestSurvivalPipeline::test_fit_cox_ph_pipeline
  /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/lifelines/fitters/coxph_fitter.py:1614: ConvergenceWarning:
  
  Newton-Raphson failed to converge sufficiently. Please see the following tips in the lifelines documentation: https://lifelines.readthedocs.io/en/latest/Examples.html#problems-with-convergence-in-the-cox-proportional-hazard-model

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED tests/integration/test_advanced_features.py::TestAdvancedFeatures::test_causal_pipeline_psm_ipw - assert 'ATE' in {'error': "'numpy.ndarray' object has no attribute 'iloc'"}
FAILED tests/integration/test_corr_cleaning.py::TestCorrPipeline::test_calculate_correlation_pipeline - assert None is not None
FAILED tests/integration/test_psm_pipeline.py::TestPSMPipeline::test_psm_full_flow - ValueError: too many values to unpack (expected 2)
FAILED tests/integration/test_robustness_check.py::TestStatisticalModulesRobustness::test_advanced_stats_robustness - ValueError: too many values to unpack (expected 2)
FAILED tests/integration/test_robustness_check.py::TestStatisticalModulesRobustness::test_correlation_robustness - AssertionError: unexpectedly None
FAILED tests/integration/test_robustness_check.py::TestStatisticalModulesRobustness::test_forest_plot_robustness - ValueError: DataFrame cannot be empty
FAILED tests/integration/test_robustness_check.py::TestStatisticalModulesRobustness::test_logistic_robustness - AssertionError: 'not found' not found in "<div class='alert alert-danger'><b>Data Preparation Failed:</b> Data preparation failed: No valid data remaining after cleaning (all rows contained missing values)</div>"
FAILED tests/integration/test_robustness_check.py::TestStatisticalModulesRobustness::test_psm_lib_robustness - ValueError: not enough values to unpack (expected 2, got 0)
FAILED tests/integration/test_robustness_check.py::TestStatisticalModulesRobustness::test_subgroup_robustness - ValueError: Missing columns: {'treatment', 'subgroup', 'outcome'}
================== 9 failed, 58 passed, 5 warnings in 15.88s ===================
Error: Process completed with exit code 1.